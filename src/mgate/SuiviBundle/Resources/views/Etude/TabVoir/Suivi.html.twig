<style>
.titre{
    min-width: 250px;
    cursor:  pointer;
    }
</style>

{# SET ACTIVE PANELS #}
{% set activeAP = (( etude.ap and etude.ap.dateSignature and etude.ap.redige and etude.ap.relu and etude.ap.spt1 and etude.ap.spt2 and etude.ap.envoye and etude.ap.receptionne ) ? "" : "in") %}
{% set activeCC = (( etude.cc and etude.cc.dateSignature and etude.cc.redige and etude.cc.relu and etude.cc.spt1 and etude.cc.spt2 and etude.cc.envoye and etude.cc.receptionne ) ? "" : "in") %}
{% set activeRM = (( activeAP or activeCC ) ? "in" : "") %}
{% set activeFA = (( activeAP and activeCC ) ? "in" : "") %}

<nav class="navbar" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ap">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
            <span class="navbar-brand titre" data-toggle="collapse" data-target="#ap"><span class="glyphicon glyphicon-hand-down"></span> Avant-Projet - v{{etude.ap.version | default('')}}</span>
     </div>
     <div class="collapse navbar-collapse navbar-ap">
        <ul class="nav navbar-nav">
            <li><a href="{{ path('mgateSuivi_ap_rediger', {'id': etude.id}) }}"><span class="glyphicon glyphicon-pencil"></span> Rediger</a></li>
          {% if etude.ap.dateSignature |default('0') %}
            <li><a href="{{ path('mgate_publi_publiposter', {'id_etude': etude.id, 'doc' : 'AP'}) }}"><span class="glyphicon glyphicon-circle-arrow-down"></span> Generer</a></li>
          {% endif %}
        </ul>
    </div>
</nav>

<div id="ap" class="collapse {{activeAP}}">
<table class="table table-striped table-bordered">
    <tr>
        <th>Date de signature</th>
        <th>Nombre de dev. estimé</th>
        <th>Présentation du projet</th>
        <th>Description</th>
        <th>Type de prestation</th>
        <th style="min-width: 200px;">Capacité des intervenants</th>
    </tr>
    <tr>
        <td>{{ ( etude.ap and etude.ap.dateSignature ) ? etude.ap.dateSignature | date("d/m/Y") : "Non signé" }}</td>
        <td>{{ etude.ap.nbrDev| default('Non estimé') }}</td>
        <td>{% if etude.presentationprojet|default(0) %}<i>Dans le cadre de son activité professionnelle, </i>{{etude.prospect.nom |default('')}}{% endif %} {{etude.presentationprojet|default('')|nl2br}}</td>
        <td>{% if etude.descriptionPrestation|default(0) %}<i>La prestation proposée par M-GaTE consiste à réaliser</i>{% endif %} {{etude.descriptionPrestation|default('')|nl2br}}</td>
        <td>{{etude.typeprestationtostring|default('')}}</td>
        <td>{% if etude.competences|default(0) %}<i>Les réalisateurs de cette étude devront donc être capables de : </i><br />{% endif %}{{etude.competences|default('')|nl2br}}</td>
    </tr>
</table>
</div>


<nav class="navbar" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-cc">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <span class="navbar-brand titre" data-toggle="collapse" data-target="#cc"><span class="glyphicon glyphicon-hand-down"></span> Convention Client - v{{etude.cc.version | default('')}}</span>
     </div>
     <div class="collapse navbar-collapse navbar-cc">
        <ul class="nav navbar-nav">
            <li><a href="{{ path('mgateSuivi_cc_rediger', {'id': etude.id}) }}"><span class="glyphicon glyphicon-pencil"></span> Rediger</a></li>
                    {% if etude.cc.dateSignature |default('0') %}
            <li><a href="{{ path('mgate_publi_publiposter', {'id_etude': etude.id, 'doc' : 'CC'}) }}"><span class="glyphicon glyphicon-circle-arrow-down"></span> Generer</a></li>
                    {% endif %}
        </ul>
    </div>
</nav>

<div id="cc" class="collapse {{activeCC}}">
    <table class="table table-striped table-bordered">
        <tr>
            <th>Date de signature</th>
            <th>Signataire Client</th>
            <th>Acompte</th>
            <th>Pourcentage Acompte</th>
        </tr>
        <tr>
            <td>{{ ( etude.cc and etude.cc.dateSignature ) ? etude.cc.dateSignature | date("d/m/Y") : "Non signé" }}</td>
            <td>{{etude.cc.signataire2.prenomnom | default('')}}</td>
            <td>{{ etude.acompte | default(0) ? "Oui" : "Non"}}</td>
            <td>{{etude.pourcentageAcompte * 100 ~ "%" | default('')}}</td>
        </tr>
    </table>
</div>

<nav class="navbar" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-rm">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <span class="navbar-brand titre"  data-toggle="collapse" data-target="#rm"><span class="glyphicon glyphicon-hand-down"></span> Récapitulatif de Mission</span>
     </div>
     <div class="collapse navbar-collapse navbar-rm">
        <ul class="nav navbar-nav">
            <li><a href="{{ path('mgateSuivi_missions_modifier', {'id': etude.id}) }}"><span class="glyphicon glyphicon-pencil"></span>  Intervenants</a></li>
        {% if etude.missions | length %}
            <!--li><a href="{#{ path('mgateSuivi_missions_repartition', {'id': etude.id}) }#}"><span class="glyphicon glyphicon-tasks"></span>  Répartition JEH</a></li-->
            <li><a href="{{ path('mgate_publi_publiposter', {'id_etude':etude.id, 'doc':'RM'}) }}"><span class="glyphicon glyphicon-circle-arrow-down"></span> Generer les RM</a></li>
            <li><a href="{{ path('mgate_publi_publiposter', {'id_etude':etude.id, 'doc':'DM'}) }}"><span class="glyphicon glyphicon-circle-arrow-down"></span> Generer les DM</a></li>
        {% endif %}
        </ul>
    </div>
</nav>
<div id="rm" class="collapse {{activeRM}}">
    <div class="row">
        {% for mission in etude.missions %}
        <div class="col-md-3">
            <table class="table table-bordered table-striped">
                <tr>
                    <td colspan="2">
                        {% include "mgateSuiviBundle:Etude:Buttons/Intervenant.html.twig" with  {'idEtude':  etude.id, 'intervenant' : mission.intervenant, 'keyMission' : loop.index0} %}
                    </td>
                </tr>
                <tr>
                    <td><a href="{{ path('mgate_publi_publiposter', {'id_etude':etude.id, 'doc':'RM', 'key' : loop.index0 }) }}"><span class="glyphicon glyphicon-circle-arrow-down"></span> RM</a></td> 
                    <td><a href="{{ path('mgate_publi_publiposter', {'id_etude':etude.id, 'doc':'DM', 'key' : loop.index0 }) }}"><span class="glyphicon glyphicon-circle-arrow-down"></span> DM</a></td>
                </tr>
                <tr>
                    <th>Date du RM</th>

                    <td>
                        Du : {{ mission.debutOm ? mission.debutOm | date("d/m/Y") : "??" }}<br />
                        Au : {{ mission.finOm ? mission.finOm | date("d/m/Y") : "??" }}
                    </td>
                </tr>
                {% set remuneration = mission.remuneration %}
                <tr>
                    <th>Nbre JEH</th>
                    <td>{{ remuneration.jehRemuneration }} JEH</td>
                </tr>
                <tr>
                    <th>Montant Brut</th>
                    <td>{{ remuneration.montantRemuneration }} €</td>
                </tr>
                <tr>
                    <th>Date de signature</th>

                    <td>{{ mission.dateSignature ? mission.dateSignature | date("d/m/Y") : "??" }}</td>
                </tr>
            </table>
        </div>
        {% endfor %}
    </div>
</div>


<nav class="navbar" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-fs">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <span class="navbar-brand titre" data-toggle="collapse" data-target="#fa"><span class="glyphicon glyphicon-hand-down"></span> factures</span>
     </div>
     <div class="collapse navbar-collapse navbar-fs">
        <ul class="nav navbar-nav">
            <li><a href="{{ path('mgateTreso_Facture_ajouter', {'etude_id': etude.id }) }}"><span class="glyphicon glyphicon-pencil"></span> Ajouter une facture</a></li>
         </ul>
    </div>
</nav>

<div id="fa" class="collapse">
    {% set montantRestant = getTotalHT(etude) %}
    <table class="table table-bordered table-striped">
        <tr>
            <th colspan="2">Factures</th>
            <th>Date de signature</th>
            <th>Montant H.T.</th>            
        </tr>
        {% for facture in etude.factures %}
        <tr>
            <td>{% if is_granted('ROLE_CA') %}
                <a title="Modifier" href="{{ path('mgateTreso_Facture_modifier', {'id': facture.id}) }}"><span class="glyphicon glyphicon-pencil"></span></a>
                &nbsp;&nbsp;&nbsp;
                <a title="Télécharger" href="{{ path('mgate_publi_publiposter', {'id_etude':etude.id, 'doc':'FI', 'key' : loop.index0 }) }}#"><span class="glyphicon glyphicon-circle-arrow-down"></span></a>
                &nbsp;&nbsp;&nbsp;
                <a title="Supprimer" href="{{ path('mgateTreso_Facture_supprimer', { 'id': facture.id }) }}"><span class="glyphicon glyphicon-remove"></span></a>
                {% endif %}
            </td>
            <td><a href="{{ path('mgateTreso_Facture_modifier', {'id': facture.id}) }}">Facture {{ facture.reference}}</a></td>
            <td></td>
            <td>{{ facture.montantHT | default(0) }} €</td>
        </tr>
        {% set montantRestant =  montantRestant - facture.montantHT | default(0) %}        
        {% endfor %}
        {# 
        <tr>
            <th colspan="4">FactureVente d'Acompte</th>
        </tr>
       <tr>
            <td style="width: 100px;">
                <a title="Modifier" href="{{ path('mgateSuivi_FactureVente_rediger', {'id_etude': etude.id, 'type': 'fa'}) }}"><span class="glyphicon glyphicon-pencil"></span></a>
                &nbsp;&nbsp;&nbsp;
                <a title="Télécharger" href="{{ path('mgate_publi_publiposter', {'id_etude': etude.id, 'doc' : 'FA'}) }}"><span class="glyphicon glyphicon-circle-arrow-down"></span></a>
            </td>
            <td style="width: 200px;">FactureVente d'Acompte</td>
            <td>{{ ( etude.fa and etude.fa.dateSignature ) ? etude.fa.dateSignature | date("d/m/Y") : "Non signé" }}</td>
            <td>{{ etude.fa.montantHT | default(0) }} €</td>
        </tr>
        {% set montantRestant =  montantRestant - etude.fa.montantHT | default(0) %}
        {% if etude.fis %}
        <tr>
            <th colspan="4">factures Intermédiaires</th>
        </tr>
        {% endif %}
        {% for fi in etude.fis %}
        <tr>
            <td>
                <a title="Modifier" href="{{ path('mgateTreso_Facture_modifier', {'id': fi.id}) }}"><span class="glyphicon glyphicon-pencil"></span></a>
                &nbsp;&nbsp;&nbsp;
                <a title="Télécharger" href="{{ path('mgate_publi_publiposter', {'id_etude':etude.id, 'doc':'FI', 'key' : loop.index0 }) }}#"><span class="glyphicon glyphicon-circle-arrow-down"></span></a>
                &nbsp;&nbsp;&nbsp;
                <a title="Supprimer" href="{{ path('mgateTreso_Facture_supprimer', { 'id': fi.id }) }}"><span class="glyphicon glyphicon-remove"></span></a>
            </td>
            <td><a href="{{ path('mgateTreso_Facture_modifier', {'id': fi.id}) }}">FactureVente intermédiaire n° {{ loop.index }}</a></td>
            <td>{{ ( fi and fi.dateSignature ) ? fi.dateSignature | date("d/m/Y") : "Non signé" }}</td>
            <td>{{ fi.montantHT | default(0) }} €</td>
        </tr>
        {% set montantRestant =  montantRestant - fi.montantHT | default(0) %}
        {% endfor %}
        <tr>
            <th colspan="4">FactureVente de solde</th>
        </tr>
        <tr>
            <td>
                <a title="Modifier" href="{{ path('mgateSuivi_FactureVente_rediger', {'id_etude': etude.id, 'type': 'fs'}) }}"><span class="glyphicon glyphicon-pencil"></span></a>
                &nbsp;&nbsp;&nbsp;
                <a title="Télécharger" href="{{ path('mgate_publi_publiposter', {'id_etude': etude.id, 'doc' : 'FS'}) }}"><span class="glyphicon glyphicon-circle-arrow-down"></span></a>
                &nbsp;&nbsp;&nbsp;
                {% if etude.fs.id | default(0) %}
                <a title="Supprimer" href="{{ path('mgateTreso_Facture_supprimer', { 'id': etude.fs.id }) }}"><span class="glyphicon glyphicon-remove"></span></a>
                {% endif %}
            </td>
            <td>FactureVente solde</td>
            <td>{{ ( etude.fs and etude.fs.dateSignature ) ? etude.fs.dateSignature | date("d/m/Y") : "Non signé" }}</td>
            <td>{{ etude.fs.montantHT | default(0) }} €</td>
        </tr>
        {% set montantRestant =  montantRestant - etude.fs.montantHT | default(0)  %}
        #}
    </table>
    <table class="table table-bordered">
        <tr>
            <th>Montant Total H.T.</th>
            <td>{{ getTotalHT(etude) | default('') }} €</td>
            <th>Reste à payer</th>
            <td>{{ montantRestant }} €</td>
        </tr>
    </table>
</div>


            
<nav class="navbar" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-pvs">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <span class="navbar-brand titre" data-toggle="collapse" data-target="#pvs"><span class="glyphicon glyphicon-hand-down"></span> Procès-Verbaux</span>
     </div>
     <div class="collapse navbar-collapse navbar-pvs">
        <ul class="nav navbar-nav">
            <li><a href="{{ path('mgateSuivi_procesverbal_rediger', {'id_etude': etude.id, 'type': 'pvr'}) }}"><span class="glyphicon glyphicon-pencil"></span> Rediger le PVR</a></li>
            <li><a href="{{ path('mgateSuivi_procesverbal_ajouter', {'id': etude.id}) }}"><span class="glyphicon glyphicon-plus"></span> Ajouter un PVI</a></li>
        </ul>
    </div>
</nav>
<div id="pvs" class="collapse">
    <table class="table table-bordered table-striped">
        <tr>
            <th colspan="2">Procès verbal</th>
            <th>Phases concernées</th>
            <th>Date de signature</th>
            <th>Signataire Client</th>
        </tr>
    {% for pvi in etude.pvis %}
        <tr>
            <td style="width: 100px;">
                <a title="Modifier" href="{{ path('mgateSuivi_procesverbal_modifier', {'id_pv': pvi.id}) }}"><span class="glyphicon glyphicon-pencil"></span></a>
                &nbsp;&nbsp;&nbsp;
                <a title="Télécharger" href="{{ path('mgate_publi_publiposter', {'id_etude':etude.id, 'doc':'PVI', 'key' : loop.index0 }) }}"><span class="glyphicon glyphicon-circle-arrow-down"></span></a>
                &nbsp;&nbsp;&nbsp;
                <a title="Supprimer" href="#"><span class="glyphicon glyphicon-remove"></span></a>
            </td>
            <td style="width: 200px;"><a href="{{ path('mgateSuivi_procesverbal_modifier', {'id_pv': pvi.id}) }}">PVI n°{{loop.index}}</a></td>
            <td>
                {% if pvi.phaseID is null %}
                    Aucune !
                {% else %}
                {{ pvi.phaseID }}
                {% endif %}
            </td>
            <td>{{ pvi.dateSignature ? pvi.dateSignature | date("d/m/Y") : "Non signé"}}</td>
            <td>{{ pvi.signataire2 ? pvi.signataire2.nomFormel }}</td>
        </tr>
    {% endfor %}
    {% if etude.pvr %}
        <tr>
            <td><a title="Modifier" href="{{ path('mgateSuivi_procesverbal_rediger', {'id_etude': etude.id, 'type': 'pvr'}) }}"><span class="glyphicon glyphicon-pencil"></span></a>
                &nbsp;&nbsp;&nbsp;
                <a title="Télécharger" href="{{ path('mgate_publi_publiposter', {'id_etude':etude.id, 'doc':'PVR' }) }}"><span class="glyphicon glyphicon-circle-arrow-down"></span></a>
            </td>
            <td><a href="{{ path('mgateSuivi_procesverbal_modifier', {'id_pv': etude.pvr.id}) }}">PVR</a></td>
            <td>Toutes</td>
            <td>{{ etude.pvr.dateSignature ? etude.pvr.dateSignature | date("d/m/Y") : "Non signé"}}</td>
            <td>{{ etude.pvr.signataire2 ? etude.pvr.signataire2.nomFormel }}</td>
        </tr>
    {% endif %}
    </table>
</div>


<nav class="navbar" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-avs">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <span class="navbar-brand titre" data-toggle="collapse" data-target="#avs"><span class="glyphicon glyphicon-hand-down"></span> Avenants</span>
     </div>
     <div class="collapse navbar-collapse navbar-avs">
        <ul class="nav navbar-nav">
             <li><a href="{{ path('mgateSuivi_av_ajouter', {'id': etude.id}) }}"><span class="glyphicon glyphicon-plus"></span> Ajouter un Avenant</a></li>
        </ul>
    </div>
</nav>
<div id="avs" class="collapse">
    <table class="table table-bordered table-striped">
        <tr>
            <th>Avenant</th>
            <th>Date de Signature</th>
            <th>Type</th>
        </tr>
    {% for av in etude.avs %}
        <tr>
            <td><a href="{{ path('mgateSuivi_av_modifier', {'id': av.id}) }}">Avenant n°{{av.id}}</a></td>
            <td>{{ av.dateSignature ? av.dateSignature | date('d/m/Y') }}</td>
            <td>{% for value in av.clauses %}{{ av.ClausesChoices[value] }}<br />{% endfor %}</td>
        </tr>
    {% endfor %}
    </table>                      
</div>
